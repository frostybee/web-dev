---
title: Implementing a Session Middleware in Slim 4 Framework
description: Implementing Session Middleware in Slim 4 Framework
draft: true
sidebar:
  label: 'Session Middleware'
  order: 6
  badge:
    text: New!
    variant: danger
---

## What is Session Middleware?

- Session middleware **automatically starts PHP sessions** for your entire application.
- Instead of calling `session_start()` in every route, the middleware does it for you once:  before any route executes.

**Why use it?**
- ✅ Write session startup code once.
- ✅ No risk of forgetting `session_start()`.
- ✅ No errors from starting sessions multiple times.
- ✅ Sessions available everywhere automatically.

---

## Creating Session Middleware

### Step 1: Create the Class

Create: `app/Middleware/SessionMiddleware.php`

```php
<?php

namespace App\Middleware;

use Psr\Http\Server\MiddlewareInterface;
use Psr\Http\Message\ResponseInterface as Response;
use Psr\Http\Message\ServerRequestInterface as Request;
use Psr\Http\Server\RequestHandlerInterface as Handler;

class SessionMiddleware implements MiddlewareInterface
{
    public function process(
        Request $request,
        Handler $handler
    ): Response
    {
        // Start session if not already started
        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }

        // Continue to next middleware/route
        return $handler->handle($request);
    }
}
```

**What's happening:**
- `session_status() === PHP_SESSION_NONE` checks if no session exists
- `session_start()` starts the session
- `$handler->handle($request)` continues to your routes

---

### Step 2: Register the Middleware

In your main application file (`config/middleware.php`):

```php
// Create instance
$sessionMiddleware = new \App\Middleware\SessionMiddleware();

// Add to application (applies to ALL routes)
$app->add($sessionMiddleware);
```

**That's it!** Sessions now work in all your routes.

---

## Using Sessions in Routes

Once registered, now you can use `$_SESSION` anywhere in your application without calling `session_start()` in every route:

```php
// Store data
$app->post('/login', function ($request, $response) {
    $_SESSION['user_id'] = 123;
    $_SESSION['username'] = 'john';
    return $response;
});

// Read data
$app->get('/profile', function ($request, $response) {
    $userId = $_SESSION['user_id'] ?? null;

    if (!$userId) {
        return $response->withStatus(401); // Not logged in
    }

    // User is logged in
    return $response;
});

// Clear data
$app->post('/logout', function ($request, $response) {
    session_destroy();
    return $response;
});
```

---

## Adding Security Settings (Optional)

You can add security configurations before `session_start()`:

```php
public function process(
    ServerRequestInterface $request,
    RequestHandlerInterface $handler
): ResponseInterface
{
    if (session_status() === PHP_SESSION_NONE) {
        // Security settings
        ini_set('session.cookie_httponly', '1'); // Prevent JavaScript access
        ini_set('session.use_strict_mode', '1'); // Reject invalid IDs
        ini_set('session.cookie_lifetime', '3600'); // 1 hour

        session_start();
    }

    return $handler->handle($request);
}
```

**Common settings:**
- `session.cookie_httponly` - Blocks JavaScript from reading cookies (security)
- `session.use_strict_mode` - Rejects suspicious session IDs (security)
- `session.cookie_lifetime` - How long session lasts (in seconds)
- `session.cookie_secure` - Only works over HTTPS (use `1` in production)

---

## Testing Your Middleware

Create a simple counter test:

```php
$app->get('/test-session', function ($request, $response) {
    $_SESSION['counter'] = ($_SESSION['counter'] ?? 0) + 1;

    $response->getBody()->write(
        "Counter: " . $_SESSION['counter']
    );

    return $response;
});
```

**Expected results:**
- Visit `/test-session` → Counter: 1
- Refresh page → Counter: 2
- Refresh again → Counter: 3

If it always shows "Counter: 1", sessions aren't persisting (see troubleshooting below).

---

## Key Best Practices

### 1. Always Check if Session Data Exists

```php
// ✅ Good - prevents errors
$userId = $_SESSION['user_id'] ?? null;

// ❌ Bad - throws error if not set
$userId = $_SESSION['user_id'];
```

### 2. Use Clear Session Key Names

```php
// ✅ Good
$_SESSION['user_id'] = 123;
$_SESSION['cart_items'] = [];

// ❌ Bad
$_SESSION['u'] = 123;
$_SESSION['data'] = [];
```

### 3. Clean Up on Logout

```php
session_unset();    // Clear all session variables
session_destroy();  // Destroy the session
```

### 4. Add Security Settings in Production

```php
ini_set('session.cookie_secure', '1');      // HTTPS only
ini_set('session.cookie_httponly', '1');    // No JavaScript
ini_set('session.use_strict_mode', '1');    // Reject invalid IDs
```

---
