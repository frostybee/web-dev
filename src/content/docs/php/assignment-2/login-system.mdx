---
title: Login System
description: Building a secure user login system with PHP
draft: true
sidebar:
  label: 'Login System'
  order: 1
  badge:
    text: assignment 2
    variant: success
---

## Welcome to Building Your Login System!

Hey there! Today we're going to build something really important - a **login system**. Think about every website you use: Facebook, Twitter, your email - they all need a way to know who you are. That's what we're building today!

By the end of this tutorial, your users will be able to:
- Create their own accounts (registration)
- Sign in securely (authentication)
- Access special protected pages (authorization)
- Log out when they're done

Let's get started!

---

## Understanding the Big Picture

Before we dive into code, let's talk about what a login system actually does.

**Imagine your website is like a building:**
- Some areas are public (anyone can enter - like the homepage or about page)
- Some areas are private (you need a key card - like your user dashboard)
- The login system is the security desk that checks your ID and gives you access

**The main pieces we'll build:**

1. **Registration** - New users create accounts (like getting an ID card)
2. **Login** - Users prove who they are (showing your ID)
3. **Sessions** - The system remembers you as you browse (like wearing a visitor badge)
4. **Protected Pages** - Areas only logged-in users can access (locked doors)
5. **Logout** - Users can leave and clear their session (returning your badge)

Pretty straightforward, right? Let's build it step by step!

---

## What You'll Build - The Complete Checklist

Before we start coding, let's see exactly what files you'll create. Use this as your roadmap!

### Database Tables
- [ ] `users` table - Stores user accounts with hashed passwords

### Controllers (app/Controllers/)
- [ ] `AuthController.php` - Handles registration, login, and logout
- [ ] `DashboardController.php` - Shows the protected dashboard page

### Models (app/Domain/Models/)
- [ ] `UserModel.php` - Database operations for users (create, find, authenticate)

### Middleware (app/Middleware/)
- [ ] `SessionMiddleware.php` - Starts sessions for every request
- [ ] `AuthMiddleware.php` - Protects routes that require login

### Views (app/Views/)
- [ ] `auth/register.php` - Registration form
- [ ] `auth/login.php` - Login form
- [ ] `dashboard/index.php` - Dashboard page for logged-in users

### Routes (app/Routes/web-routes.php)
- [ ] GET `/register` - Show registration form
- [ ] POST `/register` - Process registration
- [ ] GET `/login` - Show login form
- [ ] POST `/login` - Process login
- [ ] POST `/logout` - Log user out
- [ ] GET `/dashboard` - Protected dashboard (requires AuthMiddleware)

**That's it!** Just 2 controllers, 1 model, 2 middleware classes, 3 views, and 6 routes. You can do this!

---

## Step 1: Setting Up the Database

First things first - we need somewhere to store user accounts. Let's create a `users` table in your database.

### Creating the Users Table

Open your database tool (like phpMyAdmin) and run this SQL:

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Let's break down what each column does:**

- `id` - A unique number for each user (like a student ID)
- `username` - Their display name (must be unique!)
- `email` - Their email address (also unique - one account per email)
- `password_hash` - Their password stored **securely** (more on this soon!)
- `created_at` - When they created their account (automatic timestamp)

**Important note about passwords:** Notice we called it `password_hash`, not just `password`. That's because we NEVER store plain text passwords! We'll talk about hashing in a moment.

---

## Step 2: Creating the User Registration System

Alright, let's build the registration feature! This is where new users will create their accounts.

### Step 2.1: Building the AuthController

Controllers are like traffic cops - they direct the flow of your application. Let's create one for authentication.

**Create a new file:** `app/Controllers/AuthController.php`

Here's what your controller needs to do:

1. **Extend BaseController** - This gives you access to helpful methods for rendering views and redirecting
2. **Inject the UserModel** - We'll need this to interact with the users table
3. **Create a `register()` method** - This will handle both showing the form and processing it

**Your `register()` method needs to handle two scenarios:**

- **GET request** (someone visits the registration page): Show them the registration form
- **POST request** (someone submits the form): Process their registration

**The flow for POST requests:**

1. Check if they submitted the form using `$request->getMethod() === 'POST'`
2. Get all the form data with `$request->getParsedBody()`
3. Validate everything (we'll cover this next!)
4. Check if username or email already exists in your database
5. If everything is good, create the user
6. Redirect to login page with success message

**Pro tip:** Think of the controller as asking questions: "What kind of request is this? What data did they send? Is it valid? What should I do next?"

---

### Step 2.2: Validating User Input

Here's a critical lesson: **NEVER trust user input!** People might make mistakes, or worse, try to break your system.

**You need to validate:**

#### Required Fields Check

Create an `$errors` array and check that all fields are filled out:
- Username must not be empty
- Email must not be empty
- Password must not be empty
- Confirm password must not be empty

Use `empty()` to check each field from the form data.

#### Email Format Validation

Make sure it's actually an email address using PHP's built-in validator:
```php
filter_var($email, FILTER_VALIDATE_EMAIL)
```

**What's `FILTER_VALIDATE_EMAIL`?** It's PHP's built-in email checker - it makes sure the email looks like: `someone@example.com`

#### Password Strength

Users need strong passwords to stay safe:
- Check that the password is at least 8 characters long using `strlen()`
- Add an error message if it's too short

#### Password Confirmation

Make sure they typed their password correctly:
- Compare the `password` field with the `confirm_password` field
- They must match exactly

#### Check for Existing Users

No duplicate usernames or emails allowed:
- Use your UserModel's `findByUsername()` method to check if username exists
- Use your UserModel's `findByEmail()` method to check if email exists
- If either exists, add an appropriate error message

**If there are any errors:** Re-display the form with error messages and the user's input (so they don't have to retype everything - except passwords!).

**If validation passes:** Create the user account and redirect to the login page!

---

### Step 2.3: Password Security - Hashing Explained

Let's talk about one of the most important security concepts: **password hashing**.

**Here's the problem:** If you store passwords as plain text like "mypassword123", anyone who hacks your database can see everyone's passwords. That's a disaster!

**The solution: Hashing**

Hashing is like a one-way scrambler. It turns "mypassword123" into something like:
```
$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi
```

**The magic of hashing:**
- You can't "unscramble" it back to the original password
- The same password always produces the same hash
- Even a tiny change in the password creates a completely different hash

**In PHP, use this function to hash passwords:**

```php
$hashedPassword = password_hash($password, PASSWORD_BCRYPT);
```

**Remember:** Use `PASSWORD_BCRYPT` or `PASSWORD_ARGON2ID` - these are industry-standard algorithms that are proven to be secure.

**In your UserModel's `create()` method:**
- Hash the password before inserting into the database
- Store the hash in the `password_hash` column, NOT the original password!

---

### Step 2.4: Creating the Registration View

Now let's build the HTML form that users will see!

**Create:** `app/Views/auth/register.php`

Your registration form needs:

1. **A heading** - "Create Your Account" or similar
2. **Error display section** - Show validation errors if they exist (use a loop to display all errors)
3. **A form** that posts to the `auth.register` route with these fields:
   - Username input (repopulate with old value if validation fails)
   - Email input (repopulate with old value if validation fails)
   - Password input (type="password", never repopulate!)
   - Confirm Password input (type="password", never repopulate!)
   - Submit button
4. **A link to login page** - For users who already have accounts

**Security reminder:** Use `htmlspecialchars()` when displaying any user input to prevent XSS attacks!

---

## Step 3: Building the Login System

Great! Users can now register. Next up: letting them log in!

### Step 3.1: Creating the Login Method

Add a `login()` method to your `AuthController`.

**The login flow:**

1. Check the request method
2. If it's GET: render the login form view
3. If it's POST: process the login

**For POST requests, you need to:**

1. Get the form data using `$request->getParsedBody()`
2. Validate that username and password aren't empty
3. Call your UserModel's `authenticate()` method with the username and password
4. If authentication fails: show error message "Invalid username or password"
5. If authentication succeeds: store user info in session and redirect to dashboard

---

### Step 3.2: Password Verification

Remember how we hashed passwords when users registered? Now we need to check if the password they enter matches the hash we stored.

**Use PHP's password verification function:**

```php
password_verify($inputPassword, $storedHash)
```

**In your UserModel, create an `authenticate()` method that:**

1. Finds the user by username using your `findByUsername()` method
2. If user doesn't exist, return `null`
3. Uses `password_verify()` to check if the input password matches the stored hash
4. If password is wrong, return `null`
5. If password is correct:
   - Remove the `password_hash` from the user array (security best practice)
   - Return the user data

**Why `password_verify()` is awesome:**
- It securely compares the plain text password with the stored hash
- It's timing-attack resistant (a security feature)
- You never have to see or compare the actual passwords

**Security tip:** Always return the same generic error message whether the username or password was wrong. Don't tell attackers which one was incorrect!

---

### Step 3.3: Session Management

When someone logs in, we need to **remember** they're logged in as they navigate around the site. That's where sessions come in!

**What's a session?**
Think of it like a wristband at an amusement park. Once you pay and get your wristband, you can go on any ride without paying again. The wristband proves you're allowed to be there.

**How sessions work in PHP:**

1. When a user logs in, we store their info in `$_SESSION`
2. PHP gives them a session cookie (the wristband)
3. Every time they visit a new page, PHP checks that cookie and loads their session data
4. We can check `$_SESSION` to see who they are and if they're logged in

**After successful authentication in your login method:**

1. Store user information in `$_SESSION`:
   - User ID
   - Username
   - Email
   - A `logged_in` flag set to `true`

2. Call `session_regenerate_id(true)` for security

3. Set a flash message welcoming the user

4. Redirect to the dashboard

**What's `session_regenerate_id()`?** It creates a new session ID after login. This prevents a type of attack where hackers try to hijack your session.

---

### Step 3.4: Creating the Login View

**Create:** `app/Views/auth/login.php`

Your login form needs:

1. **A heading** - "Login to Your Account" or similar
2. **Error display section** - Show validation/authentication errors
3. **A form** that posts to the `auth.login` route with:
   - Username input field
   - Password input field
   - Submit button
4. **A link to registration page** - For users who don't have accounts yet

Keep it simple - just username and password!

---

## Step 4: Session Middleware - The Foundation

Now we need to make sure sessions are available throughout our entire application. We'll do this with **middleware**.

**What's middleware?** Think of it as a checkpoint that every request passes through before reaching your controllers.

### Step 4.1: Creating Session Middleware

**Create:** `app/Middleware/SessionMiddleware.php`

This middleware class needs to:

1. **Implement `MiddlewareInterface`** from Slim Framework
2. **Have a `process()` method** that:
   - Checks if a session is already active using `session_status() === PHP_SESSION_NONE`
   - If not active, configure security settings and start the session
   - Passes the request to the next handler

**Session security settings to configure:**
```php
ini_set('session.cookie_httponly', 1);  // Prevent JavaScript access
ini_set('session.use_only_cookies', 1); // Only use cookies for session ID
ini_set('session.cookie_samesite', 'Strict'); // CSRF protection
```

**What do these settings do?**

- `session.cookie_httponly` - Prevents JavaScript from accessing the session cookie (stops XSS attacks)
- `session.use_only_cookies` - Don't allow session IDs in URLs (more secure)
- `session.cookie_samesite` - Prevents CSRF attacks by restricting when cookies are sent

---

### Step 4.2: Registering Session Middleware Globally

In your `public/index.php`, add the session middleware to the app **before defining routes**:

```php
$app->add(SessionMiddleware::class);
```

**Why before routes?** Middleware wraps around routes like layers of an onion. The first middleware you add is the outer layer, so it runs first. We want sessions available for all routes!

---

### Step 4.3: Using Sessions in Your Controllers

Now that sessions are set up, you can use `$_SESSION` anywhere in your controllers!

**To check if someone is logged in:**
```php
if (isset($_SESSION['logged_in']) && $_SESSION['logged_in'] === true) {
    // User is authenticated
}
```

**To get current user data:**
```php
$currentUser = [
    'id' => $_SESSION['user_id'],
    'username' => $_SESSION['username'],
    'email' => $_SESSION['email']
];
```

---

### Step 4.4: Flash Messages (Bonus Feature!)

Flash messages are temporary messages that appear once and then disappear. Perfect for "Login successful!" or "Profile updated!" messages.

**To set a flash message:**
```php
$_SESSION['flash']['success'] = 'Your message here';
```

**To display flash messages in your views:**

Check if the flash message exists, display it in a div with appropriate styling, then immediately unset it. This ensures it only appears once!

You can create different types of flash messages:
- `$_SESSION['flash']['success']` - For success messages (green)
- `$_SESSION['flash']['error']` - For error messages (red)
- `$_SESSION['flash']['warning']` - For warnings (yellow)

---

## Step 5: Protecting Pages with Authentication Middleware

Some pages should only be accessible to logged-in users. Let's build middleware to enforce this!

### Step 5.1: Creating Auth Middleware

**Create:** `app/Middleware/AuthMiddleware.php`

This middleware class needs to:

1. **Implement `MiddlewareInterface`** from Slim
2. **Have a `process()` method** that:
   - Checks if user is logged in by looking for `$_SESSION['logged_in']`
   - If NOT logged in:
     - Set a flash error message
     - Create a redirect response to the login page (use RouteContext and RouteParser)
     - Return the redirect response with status 302
   - If logged in:
     - Allow the request to continue using `$handler->handle($request)`

**Think of it as a bouncer at a club:** If you're not on the list (logged in), you're redirected to the entrance (login page).

---

### Step 5.2: Applying Middleware to Routes

In your `app/Routes/web-routes.php`, you can protect routes in two ways:

**Protecting a single route:**
Add `->add(AuthMiddleware::class)` to the route definition

**Protecting multiple routes with a group:**
Wrap routes in a group and add the middleware to the entire group

**Remember the difference:**
- **Public routes** (login, register, home) - No middleware needed
- **Protected routes** (dashboard, profile, admin) - Add AuthMiddleware

---

### Step 5.3: Creating Your First Protected Page

Let's create a dashboard page that only logged-in users can see!

**Create:** `app/Controllers/DashboardController.php`

This controller needs to:

1. Extend BaseController
2. Have an `index()` method that:
   - Gets the current user from `$_SESSION`
   - Creates a user array with their id, username, and email
   - Renders the dashboard view with the user data

**Create:** `app/Views/dashboard/index.php`

This view should:

1. Display a welcome message with the user's username (use `htmlspecialchars()`)
2. Show flash messages if they exist
3. Display the user's account information
4. Include a logout form/button

**Don't forget:** Register the dashboard route in `web-routes.php` and add AuthMiddleware to protect it!

---

### Step 5.4: Testing the Full Authentication Flow

Let's test everything works together:

**Test 1: Access Protection**
1. Open your browser in incognito/private mode (fresh session)
2. Try to visit `/dashboard`
3. You should be redirected to `/login` with an error message

**Test 2: Registration**
1. Go to `/register`
2. Try submitting empty fields - you should see validation errors
3. Try a password that's too short - validation error
4. Try mismatched passwords - validation error
5. Fill in valid data and submit
6. You should be redirected to login with a success message

**Test 3: Login**
1. Try logging in with wrong credentials - error message
2. Log in with correct credentials
3. You should be redirected to `/dashboard`
4. Your username should appear on the dashboard

**Test 4: Session Persistence**
1. While logged in, navigate to other pages
2. Come back to `/dashboard`
3. You should still be logged in!

---

## Step 6: Logout Functionality

Users need a way to log out and end their session!

### Step 6.1: Creating the Logout Method

Add a `logout()` method to your `AuthController` that:

1. Stores the username for a goodbye message
2. Clears all user-related session data:
   - Unset `user_id`
   - Unset `username`
   - Unset `email`
   - Unset `logged_in`
3. Sets a flash success message
4. Redirects to the login page

**Alternative approach:** You can completely destroy the session using `session_destroy()`, but this is more complex and clears everything. The simpler approach of just unsetting user data works fine for most applications.

---

### Step 6.2: Creating the Logout Button

Add a logout form to your dashboard or navigation menu.

**IMPORTANT:** Use a POST form, NOT a link!

**Why POST instead of GET?**

- GET requests can be triggered accidentally by prefetching, images, or link crawlers
- Logout is a state-changing action and should ALWAYS use POST
- Using POST prevents accidental logouts

Create a form that posts to the `auth.logout` route with a submit button.

---

### Step 6.3: Registering the Logout Route

Add the logout route to `app/Routes/web-routes.php`:

- It should be a POST route
- Point it to the AuthController's logout method
- Give it the name `auth.logout`
- Protect it with AuthMiddleware (only logged-in users can logout!)

**Why protect the logout route?** If someone's not logged in, there's nothing to log out from!

---

## Step 7: Building the UserModel

Now let's create the model that handles all database operations for users!

**Create:** `app/Domain/Models/UserModel.php`

### Required Methods

Your UserModel needs these methods:

#### 7.1: `create($data)` - Create New User

This method should:
1. Hash the password using `password_hash()` with `PASSWORD_BCRYPT`
2. Prepare an INSERT SQL statement for the users table
3. Execute with prepared statements (never concatenate user input!)
4. Return the new user's ID using `lastInsertId()`

---

#### 7.2: `findByUsername($username)` - Find User by Username

This method should:
1. Prepare a SELECT query that searches for a user by username
2. Use a prepared statement with bound parameters
3. Execute and fetch the result
4. Return the user array if found, or `null` if not found

**Why use prepared statements?** They prevent SQL injection attacks! Never concatenate user input directly into SQL.

---

#### 7.3: `findByEmail($email)` - Find User by Email

Similar to `findByUsername`, but search by the email column instead.

---

#### 7.4: `findById($id)` - Find User by ID

Similar to the above, but search by the id column. This is useful for loading profile data or checking if a user still exists.

---

#### 7.5: `authenticate($username, $password)` - Authenticate User

This is the key method for login! It should:

1. Find the user by username using your `findByUsername()` method
2. If user doesn't exist, return `null`
3. Use `password_verify()` to check if the password matches the stored hash
4. If password is incorrect, return `null`
5. If successful:
   - Remove the `password_hash` from the user array (security!)
   - Return the user data

**This method is the heart of your login system!** It safely checks credentials without exposing passwords.

---

#### 7.6: Optional Future Methods

You can add these later for additional features:
- `update($id, $data)` - Update user profile information
- `changePassword($id, $newPassword)` - Change a user's password
- `delete($id)` - Delete a user account

---

## Security Best Practices - Important Lessons!

Let's talk about security. This is CRUCIAL for protecting your users!

### 1. Password Security

**DO:**
- Always use `password_hash()` with `PASSWORD_BCRYPT` or `PASSWORD_ARGON2ID`
- Always use `password_verify()` to check passwords
- Require minimum 8 characters (12+ is better!)
- Never store passwords in plain text
- Never send passwords via email

**DON'T:**
- Don't use MD5 or SHA1 for passwords (they're broken!)
- Don't create your own hashing algorithms
- Don't compare passwords directly with `==`

---

### 2. Session Security

**DO:**
- Always use `session_regenerate_id()` after login
- Use HTTPS in production (sessions can be hijacked on HTTP)
- Set secure cookie parameters (httponly, samesite, etc.)

**DON'T:**
- Don't put sensitive data directly in cookies
- Don't use session IDs in URLs
- Don't forget to implement logout!

---

### 3. Input Validation & Output Escaping

**DO:**
- Validate ALL user input on the server side
- Use `htmlspecialchars()` when displaying user input
- Use prepared statements for all database queries
- Validate email format with `filter_var()`

**DON'T:**
- Don't trust client-side validation alone
- Don't concatenate user input into SQL queries
- Don't echo user input without escaping

---

### 4. Error Messages

**DO:**
- Use generic error messages for authentication: "Invalid username or password"
- Log detailed errors server-side for debugging

**DON'T:**
- Don't tell users whether the username or password was wrong (helps hackers)
- Don't expose system details in error messages

---

### 5. Additional Security Measures

Consider implementing these as you grow:

**Rate Limiting:**
- Limit login attempts (e.g., 5 attempts per 15 minutes)
- Lock accounts temporarily after failed attempts
- Use CAPTCHA after multiple failures

**CSRF Protection:**
- Add CSRF tokens to all forms
- Slim Framework has built-in CSRF middleware you can use!

**Password Reset:**
- Use secure tokens with expiration
- Send reset links via email only
- Expire tokens after use

---

## Testing Your Complete Login System

### Comprehensive Testing Checklist

**Database Setup:**
- [ ] Users table created with correct columns
- [ ] Database connection working

**Registration:**
- [ ] Registration form displays
- [ ] Empty field validation works
- [ ] Email format validation works
- [ ] Password length validation works
- [ ] Password confirmation validation works
- [ ] Duplicate username detection works
- [ ] Duplicate email detection works
- [ ] Password is hashed in database (not plain text!)
- [ ] Success redirect to login works
- [ ] Flash message displays

**Login:**
- [ ] Login form displays
- [ ] Wrong credentials show error message
- [ ] Correct credentials log in successfully
- [ ] User is redirected to dashboard
- [ ] Session stores user data correctly

**Protected Pages:**
- [ ] Dashboard requires login
- [ ] Accessing dashboard without login redirects to login page
- [ ] Accessing dashboard after login works
- [ ] User information displays correctly

**Logout:**
- [ ] Logout button visible when logged in
- [ ] Clicking logout clears session
- [ ] Logout redirects to login page
- [ ] Trying to access dashboard after logout redirects to login

**Session Persistence:**
- [ ] User stays logged in across multiple page views
- [ ] Session survives browser refresh
- [ ] Multiple tabs share the same session

---

## What You've Accomplished!

Congratulations! You've just built a complete, secure login system from scratch. Let's recap what you learned:

**Core Features:**
- User registration with validation
- Secure password hashing and verification
- User authentication (login)
- Session management
- Protected pages with middleware
- Logout functionality

**Security Concepts:**
- Password hashing with bcrypt
- SQL injection prevention with prepared statements
- XSS prevention with output escaping
- Session security configuration
- CSRF protection basics
- Secure error messages

**Architecture Patterns:**
- MVC structure (Models, Views, Controllers)
- Middleware for cross-cutting concerns
- Route protection and grouping
- Flash messages for user feedback

---

## Next Steps - Enhance Your System!

Now that you have a working login system, consider adding:

### Level 2 Features:
- **Password reset via email** - Let users reset forgotten passwords
- **Email verification** - Verify email addresses are real
- **Remember me** - Keep users logged in longer
- **Profile editing** - Let users update their information

### Level 3 Features:
- **Two-factor authentication (2FA)** - Extra security layer
- **Social login** - Login with Google, Facebook, etc.
- **User roles & permissions** - Admin vs regular users
- **Activity logs** - Track user actions
- **Account deletion** - Let users delete their accounts

### Security Enhancements:
- **Rate limiting** - Prevent brute force attacks
- **CAPTCHA** - Stop bots
- **Password strength meter** - Help users choose better passwords
- **Security questions** - Additional account recovery method

---

## Final Thoughts

Building authentication systems is challenging, but you've got this! Remember:

1. **Security is not optional** - Always hash passwords, validate input, and escape output
2. **Test thoroughly** - Try to break your own system
3. **Keep learning** - Security is an ongoing journey
4. **Use proven methods** - Don't reinvent the wheel for password hashing

You now have a solid foundation for any web application that needs user accounts. Keep building, keep learning, and most importantly - keep your users' data safe!

Happy coding!
