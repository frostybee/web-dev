---
title: File Upload Lab
description: File Upload Lab
draft: true
sidebar:
  label: 'Lab: File Upload'
  order: 1
  badge:
    text: In-Class Lab
    variant: danger
---

## Additional Resources

- [PHP File Upload Documentation](https://www.php.net/manual/en/features.file-upload.php)
- [Slim 4 File Upload Documentation](https://www.slimframework.com/docs/v4/objects/request.html#uploaded-files)
- [OWASP File Upload Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)
- [PHP `getimagesize()` Documentation](https://www.php.net/manual/en/function.getimagesize.php)

## Lab Instructions: Implementing File Upload

In this lab, you will implement secure file upload functionality for your Slim 4 application. File uploads are a common requirement in web applications, allowing users to share images, documents, and other files. By the end of this lab, you'll have a fully functional and secure file upload system with proper validation and error handling.

### How File Uploads Work

When a user uploads a file through an HTML form, the file data is sent to the server as part of an HTTP POST request with a special encoding type (`multipart/form-data`). The server receives this data and temporarily stores it in a system directory. Your PHP application then processes this temporary file and moves it to a permanent location on disk.

Slim Framework makes this process straightforward by providing access to uploaded files through its PSR-7 Request object. Instead of working directly with PHP's `$_FILES` superglobal, Slim wraps uploaded files in `UploadedFileInterface` objects, which provide a clean, object-oriented API for handling file uploads.

In this lab, you'll learn how to create an upload form, receive files on the server, validate them for security, and save them safely to your server's filesystem using best practices.

---

## Learning Objectives

By completing this lab, you will:
- Understand how file uploads work in PHP and Slim 4.
- Handle uploaded files using Slim's PSR-7 request object.
- Implement file validation (type, size, MIME type).
- Securely store uploaded files with unique filenames.
- Display uploaded files to users.
- Implement proper error handling for file uploads.
- Apply security best practices to prevent malicious file uploads.

---

## Prerequisites

Before starting this lab, ensure you have:
- A working Slim 4 application with the BaseController pattern.
- Completed the Flash Messages lab (for user feedback).
- SessionMiddleware registered for flash messages.
- Bootstrap CSS included in your views (for styled forms and alerts).
- A `public/` directory for serving uploaded files.
- Your development environment set up and running.

---

## Lab Steps

### Step 1: Create the Uploads Directory

**Objective:** Set up a directory structure for storing uploaded files.

**Instructions:**

1. Navigate to your project's `public/` directory
2. Create a new folder named `uploads/`
3. Inside `uploads/`, create a subfolder named `images/`
4. Verify the directory structure:
   ```
   public/
   └── uploads/
       └── images/
   ```

5. Ensure the web server has write permissions to this directory

**What you just created:**
- A dedicated directory for uploaded files within the public folder
- A subdirectory for organizing image uploads
- A location accessible via URL for serving uploaded files

---

### Step 2: Create the HTML Upload Form

**Objective:** Create an HTML form that allows users to select and upload files.

**Key Points About the Form:**

Before creating the form, understand these essential attributes:

- **`method="POST"`:** File uploads require POST requests because file data cannot be sent via GET. GET requests only support URL parameters, which are limited in size and format.

- **`enctype="multipart/form-data"`:** This is the most critical attribute! It tells the browser to encode the form data as multiple parts (one for each form field, including files). Without this attribute, the browser will send only the filename as text, not the actual file content.

- **`<input type="file">`:** This creates the file selection button. The `name` attribute is important - you'll use this name to access the uploaded file in your PHP code.

**Instructions:**

1. Navigate to your `views/` directory
2. Create a new folder named `upload/`
3. Inside `upload/`, create a file named `uploadView.php`
4. Add the following HTML code:

```html title="views/upload/uploadView.php"
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload Demo</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">File Upload Demo</h1>

        <!-- Flash Messages Display Area -->
        <div class="mb-4">
            <?= App\Helpers\FlashMessage::render() ?>
        </div>

        <!-- Upload Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Upload an Image</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/upload" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="myfile" class="form-label">Choose a file:</label>
                        <input
                            type="file"
                            class="form-control"
                            id="myfile"
                            name="myfile"
                            accept="image/*"
                            required>
                        <div class="form-text">
                            Select an image file to upload (JPEG, PNG, GIF).
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload File</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
```

5. Save the file

**What you just created:**
- An HTML form with `method="POST"` for file uploads
- The critical `enctype="multipart/form-data"` attribute
- A file input field with `name="myfile"` (you'll use this name in PHP)
- Bootstrap styling for a clean interface
- Flash message display area for feedback

---

### Step 3: Set Up the Route in Slim

**Objective:** Create a POST route that will handle the file upload when the form is submitted.

**Understanding Slim Routes:**

In Slim, routes map URLs to handler functions (called callbacks). When a user submits the upload form, it will send a POST request to `/upload`. We need to create a route that catches this request and processes the uploaded file.

**Instructions:**

1. Open your `app/Routes/web-routes.php` file
2. Add the following route (we'll build the file processing code in the next steps):

```php
use Psr\Http\Message\ResponseInterface as Response;
use Psr\Http\Message\ServerRequestInterface as Request;

// File upload routes
$app->get('/upload', function (Request $request, Response $response) {
    // For now, just render the upload form
    $title = 'File Upload Demo';
    ob_start();
    require __DIR__ . '/../../views/upload/uploadView.php';
    $output = ob_get_clean();
    $response->getBody()->write($output);
    return $response;
})->setName('upload.index');

$app->post('/upload', function (Request $request, Response $response) {
    // File processing code will go here in the next steps
    // For now, just redirect back to the form
    return $response
        ->withHeader('Location', '/upload')
        ->withStatus(302);
})->setName('upload.process');
```

3. Save the file
4. Test by visiting `/upload` in your browser - you should see the upload form

**What you just created:**
- A GET route to display the upload form
- A POST route to handle file uploads (empty for now)
- Basic view rendering using output buffering

---

### Step 4: Access the Uploaded File

**Objective:** Retrieve the uploaded file from the request inside your POST route.

**Understanding File Access:**

Inside your route handler, use `$request->getUploadedFiles()` to retrieve all uploaded files. This method returns an associative array where the keys match the `name` attributes from your HTML form.

Since our form has an input with `name="myfile"`, we'll access the uploaded file using `$uploadedFiles['myfile']`.

Each uploaded file is an object that implements `UploadedFileInterface`, which provides methods to work with the file:
- `getError()` - Returns upload error code
- `getSize()` - Returns file size in bytes
- `getClientFilename()` - Returns original filename
- `getClientMediaType()` - Returns MIME type
- `moveTo($path)` - Moves file to permanent location

**Instructions:**

1. Open your `app/Routes/web-routes.php` file
2. Find the POST `/upload` route
3. Update it to access the uploaded file:

```php
$app->post('/upload', function (Request $request, Response $response) {
    $uploadedFiles = $request->getUploadedFiles();

    // Get the specific file we uploaded (named 'myfile' in the form)
    $uploadedFile = $uploadedFiles['myfile'];

    // For now, just redirect back
    return $response
        ->withHeader('Location', '/upload')
        ->withStatus(302);
})->setName('upload.process');
```

4. Save the file

**What you just did:**
- Retrieved all uploaded files from the request
- Accessed the specific file by form field name
- Got an UploadedFileInterface object to work with

---

### Step 5: Validate the Upload

**Objective:** Check if the upload was successful and validate file size and type.

**Why Validation Matters:**

Before processing any file, you must validate:
1. **Upload Success:** Check if the file uploaded without errors
2. **File Size:** Prevent users from uploading files that are too large
3. **File Type:** Only allow specific file types (images in our case)

These validations protect your server from malicious uploads and ensure a good user experience.

**Instructions:**

1. Open your `app/Routes/web-routes.php` file
2. Update the POST route to include validation:

```php
$app->post('/upload', function (Request $request, Response $response) use ($app) {
    $uploadedFiles = $request->getUploadedFiles();
    $uploadedFile = $uploadedFiles['myfile'];

    // Validate upload success
    if ($uploadedFile->getError() !== UPLOAD_ERR_OK) {
        FlashMessage::error('Error uploading file');
        return $response
            ->withHeader('Location', '/upload')
            ->withStatus(302);
    }

    // Validate file size (max 2MB)
    if ($uploadedFile->getSize() > 2 * 1024 * 1024) {
        FlashMessage::error('File too large (max 2MB)');
        return $response
            ->withHeader('Location', '/upload')
            ->withStatus(302);
    }

    // Validate file type
    $allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (!in_array($uploadedFile->getClientMediaType(), $allowedTypes)) {
        FlashMessage::error('Invalid file type. Only JPEG, PNG, and GIF allowed.');
        return $response
            ->withHeader('Location', '/upload')
            ->withStatus(302);
    }

    // Validation passed - continue to next step
    return $response
        ->withHeader('Location', '/upload')
        ->withStatus(302);
})->setName('upload.process');
```

3. Save the file

**What you just added:**
- Error checking using `getError()` method
- File size validation (2MB limit)
- MIME type validation for images only
- Flash messages for user feedback

---

### Step 6: Generate a Safe Filename

**Objective:** Create a unique, secure filename for the uploaded file.

**Why This Is Critical:**

Never trust user-provided filenames! Malicious users could upload files with names like:
- `../../etc/passwd` (path traversal attack)
- `script.php` (executable file disguised as image)
- `existing-file.jpg` (overwrite important files)

By generating unique filenames, you:
- Prevent path traversal attacks
- Avoid overwriting existing files
- Eliminate special characters that could cause issues

**Instructions:**

1. Continue editing the POST route in `app/Routes/web-routes.php`
2. Add filename generation after validation:

```php
$app->post('/upload', function (Request $request, Response $response) use ($app) {
    $uploadedFiles = $request->getUploadedFiles();
    $uploadedFile = $uploadedFiles['myfile'];

    // ... (previous validation code stays here) ...

    // Generate safe filename
    $extension = pathinfo($uploadedFile->getClientFilename(), PATHINFO_EXTENSION);
    $filename = uniqid('upload_') . '.' . $extension;

    // Continue to next step...
    return $response
        ->withHeader('Location', '/upload')
        ->withStatus(302);
})->setName('upload.process');
```

3. Save the file

**What you just added:**
- Extract file extension from original filename
- Generate unique filename using `uniqid()`
- Combine prefix, unique ID, and extension

---

### Step 7: Save the File to Disk

**Objective:** Move the uploaded file from temporary storage to permanent location.

**How File Storage Works:**

When a file is uploaded, PHP temporarily stores it in a system directory. You need to move it to a permanent location before the request ends, otherwise it will be deleted automatically.

**Instructions:**

1. Continue editing the POST route
2. Add file saving logic:

```php
$app->post('/upload', function (Request $request, Response $response) use ($app) {
    $uploadedFiles = $request->getUploadedFiles();
    $uploadedFile = $uploadedFiles['myfile'];

    // ... (previous validation code) ...

    // Generate safe filename
    $extension = pathinfo($uploadedFile->getClientFilename(), PATHINFO_EXTENSION);
    $filename = uniqid('upload_') . '.' . $extension;

    // Define upload directory
    $uploadDirectory = __DIR__ . '/../../public/uploads/images';

    // Create directory if it doesn't exist
    if (!is_dir($uploadDirectory)) {
        mkdir($uploadDirectory, 0755, true);
    }

    // Build full file path
    $destination = $uploadDirectory . DIRECTORY_SEPARATOR . $filename;

    // Move uploaded file to permanent location
    $uploadedFile->moveTo($destination);

    // Store filename in session for display
    if (!isset($_SESSION['uploaded_files'])) {
        $_SESSION['uploaded_files'] = [];
    }
    $_SESSION['uploaded_files'][] = $filename;

    FlashMessage::success("File uploaded successfully as: {$filename}");
    return $response
        ->withHeader('Location', '/upload')
        ->withStatus(302);
})->setName('upload.process');
```

3. Save the file

**What you just added:**
- Define upload directory path
- Create directory if needed
- Use `moveTo()` to save file permanently
- Store filename in session
- Success message for user

---

### Step 8: Display Uploaded Files (Optional Enhancement)

**Objective:** Update the view to show a gallery of uploaded files.

**Instructions:**

1. Open `views/upload/uploadView.php`
2. Add the following code after the upload form (before the closing `</div>` tag):

```php
<!-- Uploaded Files Display -->
<?php if (!empty($_SESSION['uploaded_files'])): ?>
<div class="card mt-4">
    <div class="card-header">
        <h5>Uploaded Files</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <?php foreach (array_reverse($_SESSION['uploaded_files']) as $filename): ?>
            <div class="col-md-4 mb-3">
                <div class="card">
                    <img
                        src="/uploads/images/<?= htmlspecialchars($filename) ?>"
                        class="card-img-top"
                        alt="Uploaded image"
                        style="height: 200px; object-fit: cover;">
                    <div class="card-body">
                        <p class="card-text small text-muted">
                            <?= htmlspecialchars($filename) ?>
                        </p>
                    </div>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
    </div>
</div>
<?php endif; ?>
```

3. Save the file

**What you just added:**
- Check if uploaded files exist in session
- Display files in a responsive grid layout
- Show each image with its filename
- Most recent uploads appear first

---

### Step 9: Test Your Implementation

**Objective:** Verify that file uploads work correctly and securely.

**Instructions:**

1. Start your development server (if not already running)
2. Visit `http://localhost/[your-app-name]/upload` in your browser
3. Test the following scenarios:

**Test Case 1: Valid Image Upload**
- Click "Choose File" and select a valid image (JPEG, PNG, or GIF)
- Click "Upload File"
- Expected: Green success message and image appears below

**Test Case 2: Invalid File Type**
- Try to upload a .txt or .pdf file
- Expected: Red error message about invalid file type

**Test Case 3: Large File**
- Try to upload an image larger than 2MB
- Expected: Red error message "File too large (max 2MB)"

**Test Case 4: Invalid File Type**
- Try to upload a .txt, .pdf, or .exe file
- Expected: Red error message about invalid file type

**Test Case 5: Multiple Uploads**
- Upload several different images
- Expected: All images appear in the gallery below
- Each file should have a unique filename like `upload_673abc123def.jpg`

**Expected Behavior:**

- ✅ Valid images upload successfully
- ✅ Success messages appear for successful uploads
- ✅ Error messages appear for invalid uploads
- ✅ Uploaded files appear in the `public/uploads/images/` directory
- ✅ Images display correctly in the gallery (if you added Step 8)
- ✅ Invalid file types are rejected
- ✅ Files larger than 2MB are rejected
- ✅ Each uploaded file has a unique filename with `upload_` prefix

**If uploads don't work:**
- Check that `public/uploads/images/` directory exists
- Verify write permissions on the uploads directory (0755)
- Check `upload_max_filesize` in php.ini (should be at least 2MB)
- Check `post_max_size` in php.ini (should be larger than upload_max_filesize)
- Ensure the form has `enctype="multipart/form-data"`
- Check browser console and PHP error logs
- Verify SessionMiddleware is registered for flash messages
- Make sure FlashMessage helper is available

---

## Verification Checklist

Before submitting your lab, verify the following:

- [ ] `public/uploads/images/` directory exists with proper permissions (0755)
- [ ] `views/upload/uploadView.php` exists with the upload form
- [ ] GET route `/upload` is registered in `web-routes.php`
- [ ] POST route `/upload` is registered in `web-routes.php`
- [ ] POST route includes file upload validation (error check, size, type)
- [ ] POST route generates unique filenames using `uniqid()`
- [ ] POST route saves files using `moveTo()` method
- [ ] Upload page (`/upload`) displays the form correctly
- [ ] Valid images (JPEG, PNG, GIF) upload successfully
- [ ] Invalid file types are rejected with appropriate error messages
- [ ] Files larger than 2MB are rejected
- [ ] Uploaded files have unique filenames with `upload_` prefix
- [ ] Uploaded images display in the gallery (if Step 8 completed)
- [ ] Flash messages work correctly for success and error cases
- [ ] Files are actually saved to `public/uploads/images/` directory

---

## Understanding What You Built

### UploadedFileInterface Methods

The `UploadedFileInterface` object provides these key methods for working with uploaded files:

| Method | Description | Example Usage |
|--------|-------------|---------------|
| `getError()` | Returns upload error code | `if ($file->getError() !== UPLOAD_ERR_OK)` |
| `getSize()` | Returns file size in bytes | `if ($file->getSize() > 2097152)` |
| `getClientFilename()` | Returns original filename | `pathinfo($file->getClientFilename(), PATHINFO_EXTENSION)` |
| `getClientMediaType()` | Returns MIME type | `if (in_array($file->getClientMediaType(), $allowed))` |
| `moveTo($path)` | Moves file to destination | `$file->moveTo('/path/to/destination.jpg')` |

### How File Upload Works

1. **Form Submission:** User selects file and submits form with `enctype="multipart/form-data"`
2. **File Reception:** PHP receives file in `$_FILES` superglobal, Slim wraps it in PSR-7 UploadedFileInterface
3. **Access:** Your route retrieves the file using `$request->getUploadedFiles()`
4. **Validation:** Your code validates upload errors, MIME type, and file size
5. **Unique Naming:** Generate unique filename using `uniqid()` to prevent overwrites and security issues
6. **Storage:** Move file from temporary location to permanent uploads directory using `moveTo()`
7. **Session Storage:** Save filename in session for display purposes
8. **Feedback:** Redirect with flash message (success or error)

### Security Layers Implemented

| Security Layer | Purpose | Implementation |
|----------------|---------|----------------|
| Error Check | Ensure upload succeeded | `getError() !== UPLOAD_ERR_OK` |
| Size Validation | Prevent large file attacks | `getSize() > 2MB` check |
| MIME Type Check | Verify file type from browser | `getClientMediaType()` + whitelist |
| Unique Filenames | Prevent path traversal & overwrites | `uniqid('upload_')` |
| Directory Isolation | Store files in safe location | `public/uploads/images/` |

### PHP File Upload Error Codes

| Error Code | Constant | Meaning |
|------------|----------|---------|
| 0 | `UPLOAD_ERR_OK` | Upload successful |
| 1 | `UPLOAD_ERR_INI_SIZE` | Exceeds `upload_max_filesize` |
| 2 | `UPLOAD_ERR_FORM_SIZE` | Exceeds `MAX_FILE_SIZE` in form |
| 3 | `UPLOAD_ERR_PARTIAL` | File partially uploaded |
| 4 | `UPLOAD_ERR_NO_FILE` | No file uploaded |
| 6 | `UPLOAD_ERR_NO_TMP_DIR` | Missing temp directory |
| 7 | `UPLOAD_ERR_CANT_WRITE` | Failed to write to disk |
| 8 | `UPLOAD_ERR_EXTENSION` | PHP extension stopped upload |

---

## Common Issues and Solutions

### Issue 1: "No file was uploaded" Error

**Cause:** Form missing `enctype="multipart/form-data"` attribute

**Solution:**
- Ensure form tag has: `<form method="POST" enctype="multipart/form-data">`
- This attribute is REQUIRED for file uploads

### Issue 2: File Size Limit Exceeded

**Cause:** PHP configuration limits are too low

**Solution:**
- Edit `php.ini` and increase:
  ```ini
  upload_max_filesize = 10M
  post_max_size = 12M
  ```
- Restart your web server after changes

### Issue 3: Permission Denied Errors

**Cause:** Web server doesn't have write permissions

**Solution:**
- On Windows: Right-click folder → Properties → Security → Edit permissions
- On Linux/Mac: `chmod 755 public/uploads/`
- Ensure the directory is owned by the web server user

### Issue 4: Files Not Appearing in Gallery

**Cause:** Uploaded files not tracked in session

**Solution:**
- Verify you're storing filenames in `$_SESSION['uploaded_files']`
- Check that SessionMiddleware is registered
- Ensure session_start() is called

### Issue 5: Images Not Displaying (Broken Images)

**Cause:** Incorrect file path in `src` attribute

**Solution:**
- Verify image src uses: `/uploads/images/filename.jpg`
- Check that files exist in `public/uploads/images/`
- Open browser dev tools to see 404 errors

### Issue 6: Security Warning - File Type Bypass

**Cause:** Relying only on client-side validation

**Solution:**
- ALWAYS validate on server-side in your POST route
- Check file errors, size, and MIME type
- Never trust client-provided MIME types alone
- Consider adding `getimagesize()` check for extra security

---

## Test Your Understanding

:::note[Answer the questions below]
1. Why is `enctype="multipart/form-data"` required in the form tag for file uploads?
2. Why do we validate MIME type in addition to checking the file extension?
3. What is the purpose of generating unique filenames instead of using the original filename?
4. What security risks exist if you trust user-provided filenames?
5. Why should uploaded files be stored in the `public/` directory for this lab?
6. What PHP configuration settings limit the maximum upload size, and which one should be larger?
7. How does using `uniqid()` protect against path traversal attacks?
8. Why is it important to use the Post-Redirect-Get pattern after file upload?
9. What does `UPLOAD_ERR_OK` indicate, and why do we check for it?
10. What would happen if you didn't call `moveTo()` on the uploaded file?
:::

